# 좋은 조인 쿼리

## 문제발생
* 해당 프로젝트에서는 회원을 제외하고는 모두 fk를 가지고 다른 테이블과 연관관계를 맺는다.
* 문제는 전체적인 [흐름](https://github.com/liveforone/intelligent_commerce/blob/master/Documents/FLOW.md)에서 최 상단 흐름인 주문으로 올라갈수록 연관관계가 복잡해진다는 것이다.
* 주문 엔티티는 주문한 회원, 그리고 상품과 연관관계를 맺고 있다.
* 문제는 상품에서 발생하는데, 주문상태를 배송완료로 변경하는 작업은 상품을 등록한 판매자가 해야한다.
* 그렇게 되면 상품 -> 상점 -> 판매자, 이러한 깊은 참조를 통해 판매자까지 접근하게 된다.
* 조인의 수를 줄이면 물론 좋지만, 다중조인이 무조건 나쁘다고는 생각하지 않는다.
* 그러나, **직접적인 관계를 맺는 테이블이 많아 다중조인을 하는 것이 아니라**
* 깊은 참조를 위해 중첩조인을 하는 것이 큰 문제를 야기한다.
* 성능 적인 문제부터 시작해, 쉽게 흐름(로직)을 파악하기(이해하기) 어렵게 만들고, 유지보수도 까다로워지며, 쿼리를 날릴때마다 상당히 신경써야하는 문제들이 발생한다.

## 좋은 조인 쿼리의 조건
* 직접적인 관계를 맺는 테이블의 다중조인은 허용한다.
* 이중 참조까지도 허용한다. : a 와 b, b와 c의 관계에서 a가 b를 조인하고 다시 c를 조인하는것.
* 삼중 참조부터는 허용하지 않는다. 삼중 참조시에는 전체적인 구조를 개편하던지, a 테이블과 c 테이블이 서로 관계를 맺도록 한다.

## 무조건 성능이 답일까?
* 좋은 쿼리의 조건은 무조건 성능이 답이아니다.
* 데이터베이스의 기본적인 원칙들을 지키며 설계하는 것이 옳다.
* 그러나 위의 상황처럼 큰 성능 문제를 야기함과 더불어, 이해하기 어렵거나, 유지보수 하기 어려운 상황을 발생시키게되면
* 성능과 여러가지 면들을 고려해서 테이블을 재설계 하고, 쿼리를 튜닝하는 것이 옳다.
* 특히나 효율적이지 않는 쿼리가 발생하는 경우에는 리팩토링 하는 것이 옳다고 생각한다.
* 위의 상황을 보라. d 테이블에 접근하기 위해 b, c, d 테이블을 모두 타고 d테이블의 필드에 접근하지 않은가?
* 필자는 이중 참조까지는 봐줄만 하다 생각하지만, 이것 마저도 복잡하다고 생각하는 경우,
* 단 한번의 참조만 허용하는 것도 고려해볼만 하다.

## 결론
* 결론은 단순하다.
* 다양한 테이블과 관계를 맺어 직접적인 참조를 하는것은 괜찮다.
* 다중 조인 괜찮다는 말이다. 물론 일관성을 잘 유지하기 위해 신경을 써야한다. 특히나 테이블 삭제시에 말이다.
* 그러나 관계를 맺는 테이블에 관계를 맺는 테이블에 하면서 깊은 참조를 하게되면, 효율적인 면을 고려해 리팩토링 하라는 것이다.
* **수평적 형태의 연관관계/참조는 문제 없지만, 수직적 형태의 연관관계/참조는 피해라**